# 가상 메모리

## 가상 메모리란?

- **보조기억장치의 일부를 주기억장치처럼 사용하는 것**으로, 용량이 작은 주기억장치를 마치 큰 용량을 가진 것처럼 사용하는 기법
- 프로그램을 여러 개의 작은 블록 단위로 나누어서 가상기억장치에 보관해 놓고, 프로그램 실행 시 요구되는 블록만 주기억장치에 불연속적으로 할당하여 처리

## 구현 메커니즘

### 페이징(Paging)

- 가상 메모리에 보관되어 있는 **프로그램과 주기억장치의 영역을 동일한 크기로 나눈 후**, 나눠진 프로그램을 동일하게 나눠진 **주기억장치의 영역에 적재시켜 실행하는 기법**
- 페이지(Page): 프로그램을 일정한 크기로 나눈 단위
- 페이지 프레임(Page Frame): 페이지 크기로 일정하게 나누어진 주기억장치의 단위

### 세그먼테이션(Segmentation)

- 가상 메모리에 보관되어 있는 **프로그램을 다양한 크기의 논리적인 단위로 나눈 후 주기억장치에 적재시켜 실행하는 기법**
- 세그먼트(Segment): 프로그램을 배열이나 함수 등과 같은 논리적인 크기로 나눈 단위
- 각 세그먼트는 고유한 이름과 크기를 가짐

## 페이징의 동작

### 페이징 테이블

- 각 프로세스는 **페이지 테이블**을 가짐
- **가상 페이지 번호**와 해당 페이지의 물리적 위치인 **프레임 번호** 사이의 매핑을 저장

### 페이지 부재(Page Fault)

- CPU가 **참조하려는 페이지가 물리적 메모리에 없을 때** 발생
- 이때 OS는 **필요한 페이지를 디스크에서 불러와** 물리적 메모리에 적재

### 페이지 교체 알고리즘

- **페이지 부재(Page Fault)가 발생하면** 가상기억장치에서 필요한 페이지를 찾아 주기억장치에 적재해야 하는데, 이때 주기억장치의 모든 페이지 프레임이 사용중이면 **어떤 페이지 프레임을 선택하여 교체할 것인지를 결정하는 기법**
- 종류 : OPT, FIFO, LRU, LFU, NUR, SCR 등

## 세그먼테이션의 동작

### 세그먼트 테이블

- 각 세그먼트의 **시작 주소(base)**와 **길이(limit)** 저장
- 각 세그먼트의 **권한(읽기, 쓰기, 실행)** 저장
- CPU는 이 테이블을 사용하여 물리적 메모리 주소 계산

### 주소 변환

- 논리적 주소 (세그먼트 번호, 오프셋)을 **물리적 주소로 변환**할 때 세그먼트 테이블 사용
- **세그먼트 번호**를 사용하여 세그먼트 테이블에서 **해당 세그먼트의 base 주소**를 찾음
- 이 base 주소에 **오프셋을 더하는 방식**으로 변환

### 보호 및 공유

- 세그먼테이션은 각 **세그먼트에 대한 보호 및 공유 메커니**즘 제공
- 세그먼트 테이블의 접근 권한 정보 저장 → 불법적인 메모리 액세스 방지
- 공유 세그먼트를 통해 여러 프로세스가 같은 메모리 위치의 데이터나 코드를 공유하는 것도 가능

## 단편화

### 내부 단편화

- **페이징**에서 일어남
- 페이징은 메모리를 고정된 크기의 페이지로 나눔
- 프로세스가 메모리에 로드될 때, 마지막 페이지는 전체 페이지 크기를 다 채우지 못하게 됨
- **페이지 일부분이 사용되지 않음** → 내부 단편화

### 외부 단편화

- **세그먼테이션**에서 일어남
- 세그먼테이션은 메모리를 논리적인 단위인 세그먼트로 나눔
- 메모리에 세그먼트들이 로드되고 제거될 때, 메모리의 여러 위치에 **충분한 크기의 연속된 공간이 없을 수 있음** → 외부 단편화

## 스래싱(Thrashing)

- **페이징 기법**을 사용하는 가상 메모리 시스템에서 발생
- **프로세스의 처리 시간보다 페이지 교체에 소요되는 시간이 더 많아지는 현상**

### 원인

- 다중 프로그래밍 시스템이나 가상기억장치를 사용하는 시스템에서 하나의 프로세스 수행 과정 중에 자주 페이지 부재(Page Fault)가 발생할 때

### 해결 방법

- **워킹 셋(Working Set): 프로세스가 일정 시간 동안 자주 참조하는 페이지들의 집합**
    - 자주 참조되는 워킹 셋을 주기억장치에 상주시킴으로써 페이지 부재 및 페이지 교체 현상이 줄어듦